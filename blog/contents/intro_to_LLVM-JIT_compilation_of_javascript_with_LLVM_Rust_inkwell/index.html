<!DOCTYPE html><html lang="ja" dir="ltr"><head>
  
    

  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLVM入門 - javascriptをLLVM(Rust:inkwell)でJITコンパイルするまで: silverbirder</title>
<meta property="og:title" content="LLVM入門 - javascriptをLLVM(Rust:inkwell)でJITコンパイルするまで: silverbirder">

<meta name="generator" content="rocket 0.1">
<link rel="canonical" href="https://silver-birder.github.io/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/">



  

<meta name="description" content="コンパイラ基盤であるLLVMについて、全く知識がない私が、javascriptソースコードをパースしLLVMでコンパイルできるようになりました。LLVMの記事は数多くありますが、初心者向けの記事が少なく感じたため、本記事では、できる限り分かりやすくLLVMについて紹介できる記事を書こうと思います。ソースコードは、こちらに置いています。">
<meta property="og:description" content="コンパイラ基盤であるLLVMについて、全く知識がない私が、javascriptソースコードをパースしLLVMでコンパイルできるようになりました。LLVMの記事は数多くありますが、初心者向けの記事が少なく感じたため、本記事では、できる限り分かりやすくLLVMについて紹介できる記事を書こうと思います。ソースコードは、こちらに置いています。">

  
    
<link rel="apple-touch-icon" sizes="180x180" href="../../../assets/apple-touch-icon.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="../../../assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../assets/favicon-16x16.png">
<link rel="manifest" href="../../../assets/webmanifest.json">

<meta name="msapplication-TileColor" content="#1d3557">
<meta name="theme-color" content="#1d3557">

  
    <meta property="og:site_name" content="silverbirder">
<meta property="og:type" content="website">

<meta property="og:image" content="https://www.aosabook.org/images/llvm/RetargetableCompiler.png">
<meta property="og:url" content="https://silver-birder.github.io/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/">

<meta name="twitter:card" content="summary_large_image">

  
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="">

<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&amp;display=optional" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&amp;display=optional" rel="stylesheet">

  
    <link rel="stylesheet" href="../../../3cb4adfb.css">
<link rel="stylesheet" href="../../../0f4765a3.css">
<link rel="stylesheet" href="../../../ac2ea3b8.css">
<link rel="stylesheet" href="../../../2366292e.css">

  
    <noscript><link rel="stylesheet" href="/_merged_assets/_static/search/noscript.css"></noscript>

  
    <link rel="stylesheet" href="../../../f5cf94c7.css">
  
    
  
    <noscript><link rel="stylesheet" href="/_merged_assets/_static/noscript.css"/></noscript>

  
    <link rel="stylesheet" href="../../../b1403e10.css">
  
    <meta name="twitter:creator" content="@Silver_birder">

<link rel="stylesheet" href="../../../611b393e.css" mdjs-use="">

<meta name="google-site-verification" content="-8bAm041798VvU0oItcuyuShbVINfNMLfTmP7tENPDY">
  

<link rel="preload" href="../../../b089d234.js" as="script" crossorigin="anonymous">
<link rel="preload" href="../../../d3f07d73.js" as="script" crossorigin="anonymous">
<link rel="preload" href="../../../46ae44d0.js" as="script" crossorigin="anonymous">
<link rel="preload" href="../../../dd4fcd54.js" as="script" crossorigin="anonymous">
<link rel="preload" href="../../../736906bb28.js" as="script" crossorigin="anonymous">
<link rel="preload" href="../../../90f0e617.js" as="script" crossorigin="anonymous">
</head>

  

  
  <body layout="layout-blog-details">
  

    
      <header id="main-header">
  <div class="content-area">
    
      <button id="mobile-menu-trigger" data-action="trigger-mobile-menu">
	<span class="sr-only">Show Menu</span>
	      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon">
        <path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path>
      </svg>

</button>

    
      
	<a class="logo-link" href="/">
  <img src="../../../90a4fb13.svg" alt="Rocket Logo">
  <span>silverbirder</span>
</a>



    
      <rocket-search class="search" json-url="/_merged_assets/_static/rocket-search-index.json">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 129 129" style="width: 25px;">
    <path d="M51.6 96.7c11 0 21-3.9 28.8-10.5l35 35c.8.8 1.8 1.2 2.9 1.2s2.1-.4 2.9-1.2c1.6-1.6 1.6-4.2 0-5.8l-35-35c6.5-7.8 10.5-17.9 10.5-28.8 0-24.9-20.2-45.1-45.1-45.1-24.8 0-45.1 20.3-45.1 45.1 0 24.9 20.3 45.1 45.1 45.1zm0-82c20.4 0 36.9 16.6 36.9 36.9C88.5 72 72 88.5 51.6 88.5S14.7 71.9 14.7 51.6c0-20.3 16.6-36.9 36.9-36.9z"></path>
  </svg>
</rocket-search>



    
      
  <a href="/blog/" class="
          
           active 
        ">Blog</a>
  <a href="/resume/" class="
          
          
        ">Resume</a>
  <a href="/misc/" class="
          
          
        ">Misc</a>

    
      <launch-dark-switch class="light-dark-switch" label="Toggle darkmode">Toggle darkmode</launch-dark-switch>


    
      
	<a class="social-link" href="https://github.com/Silver-birder/Silver-birder.github.io" aria-label="silverbirder on GitHub" rel="noopener noreferrer" target="_blank">
		<span class="sr-only">GitHub</span>
		
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 16" fill="none">
  <title>GitHub</title>
  <path fill="currentColor" fill-rule="evenodd" d="M8.18391.249268C3.82241.249268.253906 3.81777.253906 8.17927c0 3.46933 2.279874 6.44313 5.451874 7.53353.3965.0991.49563-.1983.49563-.3965v-1.3878c-2.18075.4956-2.67638-.9912-2.67638-.9912-.3965-.8922-.89212-1.1895-.89212-1.1895-.69388-.4957.09912-.4957.09912-.4957.793.0992 1.1895.793 1.1895.793.69388 1.2887 1.88338.8922 2.27988.6939.09912-.4956.29737-.8921.49562-1.0904-1.78425-.1982-3.5685-.8921-3.5685-3.96496 0-.89212.29738-1.586.793-2.08162-.09912-.19825-.3965-.99125.09913-2.08163 0 0 .69387-.19825 2.18075.793.59475-.19825 1.28862-.29737 1.9825-.29737.69387 0 1.38775.09912 1.98249.29737 1.4869-.99125 2.1808-.793 2.1808-.793.3965 1.09038.1982 1.88338.0991 2.08163.4956.59475.793 1.28862.793 2.08162 0 3.07286-1.8834 3.66766-3.66764 3.86586.29737.3965.59474.8921.59474 1.586v2.1808c0 .1982.0991.4956.5948.3965 3.172-1.0904 5.4518-4.0642 5.4518-7.53353-.0991-4.3615-3.6676-7.930002-8.02909-7.930002z" clip-rule="evenodd"></path>
</svg>

		
	</a>
	<a class="social-link" href="https://twitter.com/silver_birder" aria-label="silverbirder on Twitter" rel="noopener noreferrer" target="_blank">
		<span class="sr-only">Twitter</span>
		
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 274 223"><title>Twitter</title><path d="M85.98 223c-31.675 0-61.158-9.285-85.98-25.199 4.388.518 8.853.783 13.38.783 26.278 0 50.463-8.967 69.659-24.01-24.544-.453-45.258-16.669-52.395-38.953a56.014 56.014 0 0 0 10.552 1.006c5.116 0 10.071-.685 14.778-1.967-25.66-5.152-44.993-27.822-44.993-54.998 0-.236 0-.471.004-.705a55.865 55.865 0 0 0 25.406 7.015c-15.05-10.058-24.953-27.226-24.953-46.685 0-10.279 2.766-19.914 7.594-28.198 27.664 33.934 68.993 56.264 115.609 58.603a56.31 56.31 0 0 1-1.453-12.782c0-30.975 25.114-56.088 56.091-56.088 16.132 0 30.709 6.812 40.941 17.713a112.328 112.328 0 0 0 35.617-13.611c-4.188 13.097-13.081 24.089-24.662 31.031a112.148 112.148 0 0 0 32.215-8.832 114 114 0 0 1-27.988 29.035c.108 2.405.162 4.824.162 7.256C245.564 137.533 189.148 223 85.98 223" fill="currentColor"></path></svg>

		
	</a>

    
  </div>
</header>

    

    
  <div id="content-wrapper">
    <div class="content-area">
      
	<rocket-drawer id="sidebar">
  <nav slot="content" id="sidebar-nav">
    
      <a class="logo-link" href="/">
  <img src="../../../90a4fb13.svg" alt="Rocket Logo">
  <span>silverbirder</span>
</a>


    
      <rocket-navigation>
  <ul>
    <li class="current">
      <h3>Headings</h3>
      <ul><li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#module">Module</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#function">Function</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#block">Block</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#instruction">Instruction</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#参考資料">参考資料</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#開発環境">開発環境</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#hello-world-を出力">"Hello World" を出力</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#sum">SUM</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#fizzbuzz">FizzBuzz</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#四則演算するjavascriptをパース">四則演算するJavascriptをパース</a>
</li>
<li class="menu-item">
<a href="/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell/#四則演算するjavascriptをllvmで実行">四則演算するJavascriptをLLVMで実行</a>
</li></ul>
    </li>
  </ul>
  <div class="sidebar-tags">
    <h3>Date</h3>
    <div>Sat Sep 04 2021</div>
  </div>
  <div class="sidebar-tags">
    <h3>Tags</h3>
    <div class="tags">
      
        <span class="tag">LLVM</span>
      
        <span class="tag">Beginner</span>
      
        <span class="tag">Javascript</span>
      
        <span class="tag">Rust</span>
      
        <span class="tag">Inkwell</span>
      
        <span class="tag">JIT</span>
      
    </div>
  </div>
  <div class="sidebar-bottom">
  <hr> <launch-dark-switch class="light-dark-switch" label="Toggle darkmode">Toggle darkmode</launch-dark-switch>

  
    <a href="https://github.com/Silver-birder/Silver-birder.github.io/issues">Help and Feedback</a>
  
</div>

</rocket-navigation>

    
  </nav>
</rocket-drawer>


      
  <main class="markdown-body">
    <main class="markdown-body">
  
    
  <h1>LLVM入門 - javascriptをLLVM(Rust:inkwell)でJITコンパイルするまで</h1>


  <img src="https://www.aosabook.org/images/llvm/RetargetableCompiler.png" alt="">


  
    <p>コンパイラ基盤であるLLVMについて、全く知識がない私が、
javascriptソースコードをパースしLLVMでコンパイルできるようになりました。</p>
<p>LLVMの記事は数多くありますが、初心者向けの記事が少なく感じたため、
本記事では、できる限り分かりやすくLLVMについて紹介できる記事を書こうと思います。</p>
<p>ソースコードは、こちらに置いています。</p>
<p><a href="https://github.com/Silver-birder/rustscript">https://github.com/Silver-birder/rustscript</a>  <!--  TODO: embed  --></p>
<!--  TODO: TOC -->
<h1 id="自己紹介"><a class="anchor" href="#自己紹介"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>自己紹介</h1>
<p>ふだん、javascriptやpythonなどインタプリタ言語を使うエンジニアです。
LLVMについて、全く知識がなかった人間です。</p>
<h1 id="背景"><a class="anchor" href="#背景"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>背景</h1>
<p>過去に、おもちゃのブラウザ自作をやってみました。(<a href="../learning_browser_engine/">ブラウザの仕組みを学ぶ</a>)
HTMLとCSSを解析し、レンダリングするところを書き、基本的な動作を知ることができました。
HTMLとCSSとくれば、次はJSだと思い、JSを実行するエンジンを書いてみたくなりました。
ただし、WebブラウザのAPIとJS実行エンジンをバインディングする箇所(EX.DOM操作)は難しいので、
まずは、単純な処理、四則演算やfizzbuzzが処理できるものを作ろうと思いました。</p>
<h1 id="コンパイラとは"><a class="anchor" href="#コンパイラとは"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>コンパイラとは</h1>
<p>コンパイラとは、</p>
<blockquote>
<p>compiler is a computer program that translates computer code written in one programming language (the source language) into another language (the target language). The name "compiler" is primarily used for programs that translate source code from a high-level programming language to a lower level language (e.g. assembly language, object code, or machine code) to create an executable program.</p>
</blockquote>
<p>※ <a href="https://en.wikipedia.org/wiki/Compiler">https://en.wikipedia.org/wiki/Compiler</a></p>
<p>に書かれている通り、あるコードを別のコードに変換するプログラムのことをコンパイラと指します。
主に、高級言語(ex. javascript)から低級言語(ex. アセンブリ言語)への変換という意味でコンパイラが使われます。</p>
<hr>
<p>プログラムをコンパイルするというのは、主に次の順番で処理されます。</p>
<p>@startuml
rectangle ソースコード
rectangle 字句解析
rectangle 構文解析
rectangle 構文木
rectangle 中間言語
rectangle コード生成</p>
<p>ソースコード -&gt; 字句解析
字句解析 -&gt; 構文解析
構文解析 -&gt; 構文木
構文木 -&gt; 中間言語
中間言語 -&gt; コード生成
@enduml</p>
<hr>
<p>字句解析 ~ 構文木は、lexやyaccというソフトウェアが有名だと思います。
今回は、swc_ecma_parserというものを使います。swc_ecma_parserは、<a href="https://github.com/swc-project/swc">swc</a>で使われるパーサです。</p>
<blockquote>
<p>EcmaScript/TypeScript parser for the rust programming language.</p>
</blockquote>
<p>Passes almost all tests from tc39/test262.</p>
<p>※ <a href="https://rustdoc.swc.rs/swc_ecma_parser/">swc_ecma_parser</a></p>
<p>tc39/test262のテストケースをほとんどパスしているようです。
<a href="https://github.com/tc39/test262">tc39/test262</a>は、次の仕様動作を保証するテストスイートです。</p>
<pre><code>ECMA-262, ECMAScript Language Specification
ECMA-402, ECMAScript Internationalization API Specification
ECMA-404, The JSON Data Interchange Format (pdf)
</code></pre>
<p>実際のテストコードは、<a href="https://github.com/tc39/test262/tree/main/test">tc39/test262/test</a>にあります。</p>
<hr>
<p>パーサ部分を自作しようか悩みました。
自作するには、次の手順を踏むことになります。</p>
<ol>
<li>言語文法の理解</li>
<li>パース処理の実装</li>
<li>BNFやPEGからパース自動生成も可</li>
</ol>
<p>①番の言語文法について知るために、ecmascriptのBNFってどれだろうなと調べていました。
そうすると、私の調べた範囲では、次のページにたどり着きました。</p>
<p><a href="https://tc39.es/ecma262/#sec-grammar-summary">https://tc39.es/ecma262/#sec-grammar-summary</a></p>
<p>これは、先程の<a href="https://rustdoc.swc.rs/swc_ecma_parser/">swc_ecma_parser</a>のテストスイート対象<a href="https://github.com/tc39/test262/tree/main/test">tc39/test262/test</a>であったので、あえて再構築する気になれず、自作は諦めました。</p>
<hr>
<p>中間言語 ~ コード生成については、LLVMというコンパイル基盤を使おうと思います。</p>
<h1 id="llvmとは"><a class="anchor" href="#llvmとは"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>LLVMとは</h1>
<p>LLVMとは、公式ページより、</p>
<blockquote>
<p>The LLVM Project is a collection of modular and reusable compiler and toolchain technologies.</p>
</blockquote>
<p>※ <a href="https://llvm.org/">ttps://llvm.org/</a></p>
<p>LLVMプロジェクトとは、再利用性が高いコンパイラとツールチェイン技術の総称です。
LLVMは、次の特徴があります。</p>
<blockquote>
<p>LLVM is a set of compiler and toolchain technologies, which can be used to develop a front end for any programming language and a back end for any instruction set architecture. LLVM is designed around a language-independent intermediate representation (IR) that serves as a portable, high-level assembly language that can be optimized with a variety of transformations over multiple passes.</p>
</blockquote>
<p>※ <a href="https://en.wikipedia.org/wiki/LLVM">https://en.wikipedia.org/wiki/LLVM</a></p>
<p>LLVMは、任意のフロントエンド言語(コンパイラという文脈でいう変換前の言語)から任意の命令セットアーキテクチャ(以下、ISA)バックエンドへ変換できます。
また、非言語依存な中間言語(以下、IR)を中心として設計されています。</p>
<figure title="Retargetablity - The Architecture of Open Source Applications: LLVM">
<img alt="Retargetablity - The Architecture of Open Source Applications: LLVM" src="https://www.aosabook.org/images/llvm/RetargetableCompiler.png">
<figcaption>Retargetablity - The Architecture of Open Source Applications: LLVM<figcaption>
</figcaption></figcaption></figure>  
<hr>
<p>命令セットアーキテクチャは、次の意味になります。</p>
<blockquote>
<p>命令セットとは、あるマイクロプロセッサ（CPU/MPU）を動作させるための命令語の体系。プロセッサが直に解釈して実行できる機械語（マシン語）の仕様を定めたもの。</p>
</blockquote>
<p>※ <a href="https://e-words.jp/w/%E5%91%BD%E4%BB%A4%E3%82%BB%E3%83%83%E3%83%88.html">https://e-words.jp/w/命令セット.html</a></p>
<p>プロセッサを動作させるための命令は、例えばLoad(LDR)とStore(STR)です。Loadは、メモリからレジスタへセットし、Storeは、その逆です。
後で紹介する<a href="https://thedan64.github.io/inkwell/inkwell/builder/struct.Builder.html">Instruction(Builder)</a>に一覧があります。</p>
<hr>
<p>今回、LLVMのフロントエンド言語は、タイトルにある通り、Rustで書こうと思います。
単にRustでやってみたかっただけです。
LLVMライブラリとして、<a href="https://github.com/TheDan64/inkwell">inkwell</a>を使用します。
これは、LLVMのC APIを安全に使えるようにする薄いラッパーライブラリです。</p>
<hr>
<p>LLVMのバックエンドは、ローカルマシンで動かすこととします。
具体的には、<code>x86_64-apple-darwin20.6.0</code> になります。</p>
<p>試していないですが、WASMもバックエンドとして選択できるようです。
というのも、過去の記事(<a href="https://www.publickey1.jp/blog/19/webassemblyllvm_80.html">WebAssemblyに正式対応した「LLVM 8.0」がリリース － Publickey</a>)ですが、LLVMがバックエンドとしてWebAssembly(以下,WASM)をサポートしました。</p>
<ul>
<li><a href="https://thedan64.github.io/inkwell/inkwell/targets/struct.Target.html#method.initialize_webassembly">Target initialize_webassembly</a></li>
</ul>
<p>ちなみに、WASMは、仮想的なISAとして設計されています。</p>
<blockquote>
<p>WebAssembly, or "wasm", is a general-purpose virtual ISA designed to be a compilation target for a wide variety of programming languages.</p>
</blockquote>
<p><a href="https://github.com/sunfishcode/wasm-reference-manual/blob/master/WebAssembly.md">WebAssembly Reference Manual</a></p>
<h1 id="llvm開発で知っておくべきこと"><a class="anchor" href="#llvm開発で知っておくべきこと"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>LLVM開発で、知っておくべきこと</h1>
<p>LLVMでは、IRを生成します。
そのIRでは、<code>Module ⊇ Function ⊇ Block ⊇ Instruction(Builder)</code> という構成になっています。
これを知っていないと、LLVMのコードを見ても、理解しにくいと思います。(自身が持つ言葉で解釈して誤った理解になりかねません)</p>
<p>小さなC言語コードとIRで例を示します。
Rustじゃなく、Cを選んだのは、clangから手軽にIRを出力できるからです。</p>
<pre class="language-c"><code class="language-c"><span class="token comment">// if.c</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i is one."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>これをIRに変換</p>
<pre class="language-shell"><code class="language-shell">$ clang -S -emit-llvm -O3 if.c
</code></pre>
<p>出力されたファイルは、<code>if.ll</code>というIRファイルです。
そこから、<code>@main</code>コードを見ます。</p>
<pre><code>@.str = private unnamed_addr constant [10 x i8] c"i is one.\00", align 1

define i32 @main() local_unnamed_addr #0 {
  %1 = tail call i32 @rand() #3
  %2 = icmp eq i32 %1, 1
  br i1 %2, label %3, label %5

3:                                                ; preds = %0
  %4 = tail call i32 (i8*, ...) @printf(i8* nonnull dereferenceable(1) getelementptr inbounds ([10 x i8], [10 x i8]* @.str, i64 0, i64 0))
  br label %5

5:                                                ; preds = %3, %0
  ret i32 0
}

declare i32 @rand() local_unnamed_addr #1

declare noundef i32 @printf(i8* nocapture noundef readonly, ...) local_unnamed_addr #2
</code></pre>
<p>IRをModule,Function,Block,Instructionで区切って見ると、次の画像のとおりです。</p>
<p><img src="https://res.cloudinary.com/silverbirder/image/upload/v1633770792/silver-birder.github.io/blog/sample_llvm_code.png" alt="sample_llvm_code" rocket-image="responsive"></p>
<p>それぞれ、どういうものか簡単に説明します。</p>
<h2 id="module"><a class="anchor" href="#module"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Module</h2>
<blockquote>
<p>LLVM programs are composed of Module’s, each of which is a translation unit of the input programs.</p>
</blockquote>
<p>※ <a href="https://llvm.org/docs/LangRef.html#module-structure">https://llvm.org/docs/LangRef.html#module-structure</a></p>
<p>モジュールは、入力プログラムの変換単位になります。
モジュールには、関数、グローバル変数、シンボルテーブルエントリを持ちます。</p>
<h2 id="function"><a class="anchor" href="#function"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Function</h2>
<blockquote>
<p>LLVM function definitions consist of the “define” keyword.</p>
</blockquote>
<p>A function definition contains a list of basic blocks.</p>
<p>※ <a href="https://llvm.org/docs/LangRef.html#functions">https://llvm.org/docs/LangRef.html#functions</a></p>
<p>関数は、複数のブロック(Block)を持ちます。</p>
<h2 id="block"><a class="anchor" href="#block"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Block</h2>
<blockquote>
<p>Each basic block may optionally start with a label (giving the basic block a symbol table entry), contains a list of instructions, and ends with a terminator instruction (such as a branch or function return).</p>
</blockquote>
<p>※ <a href="https://llvm.org/docs/LangRef.html#functions">https://llvm.org/docs/LangRef.html#functions</a></p>
<p>ブロックは、ラベルから始まり、複数の命令(Instruction)を持ちます。</p>
<h2 id="instruction"><a class="anchor" href="#instruction"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Instruction</h2>
<blockquote>
<p>The LLVM instruction set consists of several different classifications of instructions: terminator instructions, binary instructions, bitwise binary instructions, memory instructions, and other instructions.</p>
</blockquote>
<p>※ <a href="https://llvm.org/docs/LangRef.html#instruction-reference">https://llvm.org/docs/LangRef.html#instruction-reference</a></p>
<p>命令は、バイナリ命令やメモリ命令など、様々な命令があります。</p>
<h2 id="参考資料"><a class="anchor" href="#参考資料"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>参考資料</h2>
<p>参考になる資料たちは、次のとおりです。</p>
<ul>
<li>チュートリアル
<ul>
<li>C++ <a href="https://llvm.org/docs/tutorial/">Kaleidoscope</a></li>
<li>Rust <a href="https://github.com/jauhien/iron-kaleidoscope">Kaleidoscope</a>
<ul>
<li>codegenが動かないため、途中までしか使えません</li>
</ul>
</li>
<li>Rust + inkwell <a href="https://github.com/TheDan64/inkwell/blob/master/examples/kaleidoscope">Kaleidoscope</a></li>
</ul>
</li>
<li>LLVMリファレンス
<ul>
<li><a href="https://llvm.org/docs/LangRef.html">LLVM Language Reference Manual</a></li>
</ul>
</li>
</ul>
<h1 id="llvmをやってみよう"><a class="anchor" href="#llvmをやってみよう"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>LLVMをやってみよう</h1>
<p>前置きが長くなりましたが、実際にLLVMをやっていきたいと思います。</p>
<h2 id="開発環境"><a class="anchor" href="#開発環境"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>開発環境</h2>
<p>私の環境(Mac)はこちらです。</p>
<pre class="language-shell"><code class="language-shell">$ sw_vers 
ProductName:    macOS
ProductVersion: <span class="token number">11.6</span>
BuildVersion:   20G165
$ cargo --version <span class="token operator">&amp;&amp;</span> rustc --version
cargo <span class="token number">1.56</span>.0-nightly <span class="token punctuation">(</span>18751dd3f <span class="token number">2021</span>-09-01<span class="token punctuation">)</span>
rustc <span class="token number">1.56</span>.0-nightly <span class="token punctuation">(</span>50171c310 <span class="token number">2021</span>-09-01<span class="token punctuation">)</span>
</code></pre>
<p>llvmのインストールは、Macユーザなので、<a href="https://formulae.brew.sh/formula/llvm">brewからllvm</a>をインストールします。
<a href="https://releases.llvm.org/download.html">公式ページからダウンロード</a>もできるようです。</p>
<p>インストールが完了すると、clangやllcといったツールが使えます。</p>
<pre class="language-shell"><code class="language-shell">$ clang --version
Homebrew clang version <span class="token number">13.0</span>.0
Target: x86_64-apple-darwin20.6.0
Thread model: posix
InstalledDir: /usr/local/opt/llvm/bin
$ llc -version
Homebrew LLVM version <span class="token number">12.0</span>.1
</code></pre>
<p>MacにはXcodeにclangが含まれているようです。こちらを使っても問題ありません。
(ただ、xcodeのclangには、<a href="https://github.com/WebAssembly/wasi-sdk/issues/172#issuecomment-772399153">wasmには対応していないです</a>)</p>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># xcode付属のclangの場合</span>
$ clang --version
Apple clang version <span class="token number">12.0</span>.5 <span class="token punctuation">(</span>clang-1205.0.22.9<span class="token punctuation">)</span>
Target: x86_64-apple-darwin20.6.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin
</code></pre>
<p>Cargo.tomlの<code>dependencies</code>は、次のとおりです。</p>
<pre class="language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">inkwell</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">git</span> <span class="token punctuation">=</span> <span class="token string">"https://github.com/TheDan64/inkwell"</span><span class="token punctuation">,</span> <span class="token key property">branch</span> <span class="token punctuation">=</span> <span class="token string">"master"</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"llvm12-0"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token key property">swc_ecma_parser</span> <span class="token punctuation">=</span> <span class="token string">"0.73.0"</span>
<span class="token key property">swc_common</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.13.0"</span><span class="token punctuation">,</span> <span class="token key property">features</span><span class="token punctuation">=</span><span class="token punctuation">[</span><span class="token string">"tty-emitter"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token key property">swc_ecma_ast</span> <span class="token punctuation">=</span> <span class="token string">"0.54.0"</span>
</code></pre>
<h2 id="hello-world-を出力"><a class="anchor" href="#hello-world-を出力"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>"Hello World" を出力</h2>
<p>まずは、Hello World を出力します。
Rustのコードは、次のものになります。</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> inkwell<span class="token punctuation">;</span>

<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>context<span class="token punctuation">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>OptimizationLevel<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i32_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">i32_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i8_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">i8_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i8_ptr_type <span class="token operator">=</span> i8_type<span class="token punctuation">.</span><span class="token function">ptr_type</span><span class="token punctuation">(</span>inkwell<span class="token punctuation">::</span>AddressSpace<span class="token punctuation">::</span>Generic<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Module</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_module</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Function</span>
    <span class="token keyword">let</span> printf_fn_type <span class="token operator">=</span> i32_type<span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i8_ptr_type<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> printf_function <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token string">"printf"</span><span class="token punctuation">,</span> printf_fn_type<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> main_fn_type <span class="token operator">=</span> i32_type<span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> main_function <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> main_fn_type<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Block</span>
    <span class="token keyword">let</span> entry_basic_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>main_function<span class="token punctuation">,</span> <span class="token string">"entry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction(Builder)</span>
    <span class="token keyword">let</span> builder <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>entry_basic_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> hw_string_ptr <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_global_string_ptr</span><span class="token punctuation">(</span><span class="token string">"Hello, world!\n"</span><span class="token punctuation">,</span> <span class="token string">"hw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_call</span><span class="token punctuation">(</span>printf_function<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>hw_string_ptr<span class="token punctuation">.</span><span class="token function">as_pointer_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"call"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_return</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i32_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> execution_engine <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">create_jit_execution_engine</span><span class="token punctuation">(</span>OptimizationLevel<span class="token punctuation">::</span>Aggressive<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        execution_engine<span class="token punctuation">.</span>get_function<span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>実行してみます。</p>
<pre class="language-shell"><code class="language-shell">$ cargo run
Hello, world<span class="token operator">!</span>
</code></pre>
<p>LLVMのJITコンパイラで実行できました。
ちなみに、IRがどんなものか確認したい場合は、<code>module.print_to_file</code> を使いましょう。
実際に出力してみると、次の結果になります。</p>
<pre><code>; ModuleID = 'main'
source_filename = "main"

@hw = private unnamed_addr constant [15 x i8] c"Hello, world!\0A\00", align 1

declare i32 @printf(i8*, ...)

define i32 @main() {
entry:
  %call = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([15 x i8], [15 x i8]* @hw, i32 0, i32 0))
  ret i32 0
}
</code></pre>
<p>Rustの<code>execution_engine.get_function::&lt;unsafe extern "C" fn()&gt;("main").unwrap().call();</code>は、IRの<code>@main</code>関数を実行しています。
<code>@main</code>関数では、<code>@printf</code>関数を実行していますが、それは、C言語の<code>printf</code>になります。</p>
<p>IRのコードに関する調査は、<a href="https://llvm.org/docs/LangRef.html">LLVM Language Reference Manual</a> が重宝します。
<code>getelementptr</code>を調査してみると面白いです。</p>
<h2 id="sum"><a class="anchor" href="#sum"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>SUM</h2>
<p>次は、3つの数値を引数とし、足し算した結果を返す関数SUMを作成してみます。
Rustのコードは、次のものになります。</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> inkwell<span class="token punctuation">;</span>

<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>OptimizationLevel<span class="token punctuation">;</span>
<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>context<span class="token punctuation">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>error<span class="token punctuation">::</span>Error<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i64_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">i64_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fn_type <span class="token operator">=</span> i64_type<span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i64_type<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i64_type<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i64_type<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Module</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_module</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> builder <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Function</span>
    <span class="token keyword">let</span> function <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token string">"sum"</span><span class="token punctuation">,</span> fn_type<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Block</span>
    <span class="token keyword">let</span> basic_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> <span class="token string">"entry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction(Builder)</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>basic_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">get_nth_param</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_int_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">get_nth_param</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_int_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> z <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">get_nth_param</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_int_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_int_add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">"sum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_int_add</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> sum<span class="token punctuation">,</span> <span class="token string">"sum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_return</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> execution_engine <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">create_jit_execution_engine</span><span class="token punctuation">(</span>OptimizationLevel<span class="token punctuation">::</span>None<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> 
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1u64</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">2u64</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> <span class="token number">3u64</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> r <span class="token operator">=</span> execution_engine<span class="token punctuation">.</span>get_function<span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span>u64<span class="token punctuation">,</span> u64<span class="token punctuation">,</span> u64<span class="token punctuation">)</span><span class="token punctuation">-&gt;</span> u64<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"sum"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>実行してみます。</p>
<pre class="language-shell"><code class="language-shell">$ cargo run
<span class="token number">6</span>
</code></pre>
<p>見事、<code>1 + 2 + 3</code>の足し算ができました。
ちなみに、IRも出力しておきます。</p>
<pre><code>; ModuleID = 'main'
source_filename = "main"
target datalayout = "e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"

define i64 @sum(i64 %0, i64 %1, i64 %2) {
entry:
  %sum = add i64 %0, %1
  %sum1 = add i64 %2, %sum
  ret i64 %sum1
}
</code></pre>
<p>前回同様、Rustの<code>execution_engine.get_function::&lt;unsafe extern "C" fn(u64, u64, u64)-&gt; u64&gt;("sum")?.call(x, y , z);</code>は、IRの<code>@sum</code>関数に該当します。
足し算の<code>Instruction</code>が使えました。</p>
<h2 id="fizzbuzz"><a class="anchor" href="#fizzbuzz"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>FizzBuzz</h2>
<p>では、次はFizzBuzzをしてみます。割り算やifの命令が新しく使います。
Rustのコードは、次のものになります。</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> inkwell<span class="token punctuation">;</span>

<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>context<span class="token punctuation">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>IntPredicate<span class="token punctuation">::</span>EQ<span class="token punctuation">;</span>
<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>OptimizationLevel<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>error<span class="token punctuation">::</span>Error<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i64_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">i64_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> void_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">void_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i8_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">i8_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> i8_ptr_type <span class="token operator">=</span> i8_type<span class="token punctuation">.</span><span class="token function">ptr_type</span><span class="token punctuation">(</span>inkwell<span class="token punctuation">::</span>AddressSpace<span class="token punctuation">::</span>Generic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fn_type <span class="token operator">=</span> i64_type<span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i64_type<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> null <span class="token operator">=</span> i8_ptr_type<span class="token punctuation">.</span><span class="token function">const_null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Module</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_module</span><span class="token punctuation">(</span><span class="token string">"fizz_buzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Function</span>
    <span class="token keyword">let</span> printf_fn_type <span class="token operator">=</span> void_type<span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>i8_ptr_type<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> printf_function <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token string">"printf"</span><span class="token punctuation">,</span> printf_fn_type<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fizz_buzz_function <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token string">"fizz_buzz"</span><span class="token punctuation">,</span> fn_type<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Block</span>
    <span class="token keyword">let</span> block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"entry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction</span>
    <span class="token keyword">let</span> builder <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fizz_buzz_string_ptr <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_global_string_ptr</span><span class="token punctuation">(</span><span class="token string">"FizzBuzz\n"</span><span class="token punctuation">,</span> <span class="token string">"fizz_buzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fizz_string_ptr <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_global_string_ptr</span><span class="token punctuation">(</span><span class="token string">"Fizz\n"</span><span class="token punctuation">,</span> <span class="token string">"fizz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> buzz_string_ptr <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_global_string_ptr</span><span class="token punctuation">(</span><span class="token string">"Buzz\n"</span><span class="token punctuation">,</span> <span class="token string">"buzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> param_0 <span class="token operator">=</span> fizz_buzz_function
        <span class="token punctuation">.</span><span class="token function">get_nth_param</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_int_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> rem_divied_by_3 <span class="token operator">=</span>
        builder<span class="token punctuation">.</span><span class="token function">build_int_signed_rem</span><span class="token punctuation">(</span>param_0<span class="token punctuation">,</span> i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rem_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rem_divied_by5 <span class="token operator">=</span>
        builder<span class="token punctuation">.</span><span class="token function">build_int_signed_rem</span><span class="token punctuation">(</span>param_0<span class="token punctuation">,</span> i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rem_5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rem_divied_by15 <span class="token operator">=</span>
        builder<span class="token punctuation">.</span><span class="token function">build_int_signed_rem</span><span class="token punctuation">(</span>param_0<span class="token punctuation">,</span> i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rem_15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> comp_that_is_divisible_by_3 <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_int_compare</span><span class="token punctuation">(</span>
        EQ<span class="token punctuation">,</span>
        rem_divied_by_3<span class="token punctuation">,</span>
        i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"if_can_divide_by_3"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> comp_that_is_divisible_by_5 <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_int_compare</span><span class="token punctuation">(</span>
        EQ<span class="token punctuation">,</span>
        rem_divied_by5<span class="token punctuation">,</span>
        i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"if_can_divide_by_5"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> comp_that_is_divisible_by_15 <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build_int_compare</span><span class="token punctuation">(</span>
        EQ<span class="token punctuation">,</span>
        rem_divied_by15<span class="token punctuation">,</span>
        i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"if_can_divide_by_15"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Block</span>
    <span class="token keyword">let</span> fizz_buzz_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"fizz_buzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fizz_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"fizz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> buzz_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"buzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> num_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"num"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> else_1_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"else_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> else_2_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"else_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> end_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>fizz_buzz_function<span class="token punctuation">,</span> <span class="token string">"end_block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction</span>
    builder<span class="token punctuation">.</span><span class="token function">build_conditional_branch</span><span class="token punctuation">(</span>comp_that_is_divisible_by_15<span class="token punctuation">,</span> fizz_buzz_block<span class="token punctuation">,</span> else_1_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>fizz_buzz_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_call</span><span class="token punctuation">(</span>
        printf_function<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span>fizz_buzz_string_ptr<span class="token punctuation">.</span><span class="token function">as_pointer_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"print_fizz_buzz"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_unconditional_branch</span><span class="token punctuation">(</span>end_block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>else_1_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_conditional_branch</span><span class="token punctuation">(</span>comp_that_is_divisible_by_3<span class="token punctuation">,</span> fizz_block<span class="token punctuation">,</span> else_2_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>fizz_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_call</span><span class="token punctuation">(</span>
        printf_function<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span>fizz_string_ptr<span class="token punctuation">.</span><span class="token function">as_pointer_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"print_fizz"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_unconditional_branch</span><span class="token punctuation">(</span>end_block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>else_2_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_conditional_branch</span><span class="token punctuation">(</span>comp_that_is_divisible_by_5<span class="token punctuation">,</span> buzz_block<span class="token punctuation">,</span> num_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>buzz_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_call</span><span class="token punctuation">(</span>
        printf_function<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span>buzz_string_ptr<span class="token punctuation">.</span><span class="token function">as_pointer_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"print_buzz"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_unconditional_branch</span><span class="token punctuation">(</span>end_block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>num_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_call</span><span class="token punctuation">(</span>
        printf_function<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span>buzz_string_ptr<span class="token punctuation">.</span><span class="token function">as_pointer_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// TODO: Print input num.</span>
        <span class="token string">"print_num"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_unconditional_branch</span><span class="token punctuation">(</span>end_block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Instruction</span>
    builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>end_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">build_return</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> e <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">create_jit_execution_engine</span><span class="token punctuation">(</span>OptimizationLevel<span class="token punctuation">::</span>None<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">15u64</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span>get_function<span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"fizz_buzz"</span><span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>if文では、<code>build_conditional_branch</code>と<code>build_unconditional_branch</code>がどうやら使うそうです。
<a href="https://github.com/TheDan64/inkwell/blob/master/examples/kaleidoscope/main.rs">inkwell/examples/kaleidoscope/main.rs</a>で書いてありましたので、使ってみました。
実行してみます。15を引数として呼んでいます。</p>
<pre class="language-shell"><code class="language-shell">$ cargo run
FizzBuzz
</code></pre>
<p>成功です！
ちなみに、IRも出力しておきます。</p>
<pre><code>; ModuleID = 'fizz_buzz'
source_filename = "fizz_buzz"

@fizz_buzz.1 = private unnamed_addr constant [10 x i8] c"FizzBuzz\0A\00", align 1
@fizz = private unnamed_addr constant [6 x i8] c"Fizz\0A\00", align 1
@buzz = private unnamed_addr constant [6 x i8] c"Buzz\0A\00", align 1

declare void @printf(i8*, ...)

define i64 @fizz_buzz(i64 %0) {
entry:
  %rem_3 = srem i64 %0, 3
  %rem_5 = srem i64 %0, 5
  %rem_15 = srem i64 %0, 15
  %if_can_divide_by_3 = icmp eq i64 %rem_3, 0
  %if_can_divide_by_5 = icmp eq i64 %rem_5, 0
  %if_can_divide_by_15 = icmp eq i64 %rem_15, 0
  br i1 %if_can_divide_by_15, label %fizz_buzz, label %else_1

fizz_buzz:                                        ; preds = %entry
  call void (i8*, ...) @printf(i8* getelementptr inbounds ([10 x i8], [10 x i8]* @fizz_buzz.1, i32 0, i32 0))
  br label %end_block

fizz:                                             ; preds = %else_1
  call void (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @fizz, i32 0, i32 0))
  br label %end_block

buzz:                                             ; preds = %else_2
  call void (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @buzz, i32 0, i32 0))
  br label %end_block

num:                                              ; preds = %else_2
  call void (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @buzz, i32 0, i32 0))
  br label %end_block

else_1:                                           ; preds = %entry
  br i1 %if_can_divide_by_3, label %fizz, label %else_2

else_2:                                           ; preds = %else_1
  br i1 %if_can_divide_by_5, label %buzz, label %num

end_block:                                        ; preds = %num, %buzz, %fizz, %fizz_buzz
  ret i8* null
}
</code></pre>
<p>Blockがめちゃくちゃ増えました。それはFizzBuzzのif,elseが多いからですね。
LLVMについて、少し自信がついてきました。
これまで<code>中間言語 ~ コード生成</code>をLLVMでやってみました。
少し戻って、<code>字句解析 ~ 構文木</code>の部分、つまりパース処理をやってみます。</p>
<h2 id="四則演算するjavascriptをパース"><a class="anchor" href="#四則演算するjavascriptをパース"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>四則演算するJavascriptをパース</h2>
<p>javascriptをパースしてみます。<a href="https://rustdoc.swc.rs/swc_ecma_parser/">swc_ecma_parser</a>を使います。
パースするjavascriptは、次のものになります。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// ./src/test.js</span>
<span class="token number">20</span> <span class="token operator">/</span> <span class="token number">10</span>
</code></pre>
<p>Rustのコードは、次のものになります。</p>
<pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_use]</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> swc_common<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> swc_ecma_ast<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> swc_ecma_parser<span class="token punctuation">;</span>

<span class="token keyword">use</span> std<span class="token punctuation">::</span>path<span class="token punctuation">::</span>Path<span class="token punctuation">;</span>

<span class="token keyword">use</span> swc_common<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>Lrc<span class="token punctuation">;</span>
<span class="token keyword">use</span> swc_common<span class="token punctuation">::</span><span class="token punctuation">{</span>
    errors<span class="token punctuation">::</span><span class="token punctuation">{</span>ColorConfig<span class="token punctuation">,</span> Handler<span class="token punctuation">}</span><span class="token punctuation">,</span>
    SourceMap<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> swc_ecma_parser<span class="token punctuation">::</span><span class="token punctuation">{</span>lexer<span class="token punctuation">::</span>Lexer<span class="token punctuation">,</span> Parser<span class="token punctuation">,</span> StringInput<span class="token punctuation">,</span> Syntax<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cm<span class="token punctuation">:</span> Lrc<span class="token operator">&lt;</span>SourceMap<span class="token operator">&gt;</span> <span class="token operator">=</span> Default<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> Handler<span class="token punctuation">::</span><span class="token function">with_tty_emitter</span><span class="token punctuation">(</span>ColorConfig<span class="token punctuation">::</span>Auto<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span>cm<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fm <span class="token operator">=</span> cm
        <span class="token punctuation">.</span><span class="token function">load_file</span><span class="token punctuation">(</span>Path<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"./src/test.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"failed to load test.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lexer <span class="token operator">=</span> Lexer<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        Syntax<span class="token punctuation">::</span><span class="token function">Es</span><span class="token punctuation">(</span>Default<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// JscTarget defaults to es5</span>
        Default<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        StringInput<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>fm<span class="token punctuation">)</span><span class="token punctuation">,</span>
        None<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> parser <span class="token operator">=</span> Parser<span class="token punctuation">::</span><span class="token function">new_from</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> e <span class="token keyword">in</span> parser<span class="token punctuation">.</span><span class="token function">take_errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">into_diagnostic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> _module <span class="token operator">=</span> parser
        <span class="token punctuation">.</span><span class="token function">parse_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span><span class="token keyword">mut</span> e<span class="token operator">|</span> e<span class="token punctuation">.</span><span class="token function">into_diagnostic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"failed to parser module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> _module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>実行してみます。</p>
<pre class="language-shell"><code class="language-shell">$ cargo run
Module <span class="token punctuation">{</span> span: Span <span class="token punctuation">{</span> lo: BytePos<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>, hi: BytePos<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>, ctxt: <span class="token comment">#0 }, body: [Stmt(Expr(ExprStmt { span: Span { lo: BytePos(0), hi: BytePos(8), ctxt: #0 }, expr: Bin(BinExpr { span: Span { lo: BytePos(0), hi: BytePos(7), ctxt: #0 }, op: "/", left: Lit(Num(Number { span: Span { lo: BytePos(0), hi: BytePos(2), ctxt: #0 }, value: 20.0 })), right: Lit(Num(Number { span: Span { lo: BytePos(5), hi: BytePos(7), ctxt: #0 }, value: 10.0 })) }) }))], shebang: None }</span>
</code></pre>
<p>それっぽい結果(20.0や10.0)が出力されましたね！</p>
<h2 id="四則演算するjavascriptをllvmで実行"><a class="anchor" href="#四則演算するjavascriptをllvmで実行"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>四則演算するJavascriptをLLVMで実行</h2>
<p>最後に、swc_ecma_parserとLLVMを組み合わせて、<code>字句解析 ~ 構文木</code>と<code>中間言語 ~ コード生成</code>を繋げ、四則演算するJSをパースし、LLVMで実行してみます。</p>
<p>パースするjavascriptは、次のものになります。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// ./src/test.js</span>
<span class="token number">20</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre>
<p>Rustのコードは、次のものになります。</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> inkwell<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> swc_common<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> swc_ecma_ast<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> swc_ecma_parser<span class="token punctuation">;</span>

<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>context<span class="token punctuation">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">use</span> inkwell<span class="token punctuation">::</span>OptimizationLevel<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>error<span class="token punctuation">::</span>Error<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">::</span>path<span class="token punctuation">::</span>Path<span class="token punctuation">;</span>
<span class="token keyword">use</span> swc_common<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>Lrc<span class="token punctuation">;</span>
<span class="token keyword">use</span> swc_common<span class="token punctuation">::</span><span class="token punctuation">{</span>
    errors<span class="token punctuation">::</span><span class="token punctuation">{</span>ColorConfig<span class="token punctuation">,</span> Handler<span class="token punctuation">}</span><span class="token punctuation">,</span>
    SourceMap<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> swc_ecma_ast<span class="token punctuation">::</span>Lit<span class="token punctuation">::</span>Num<span class="token punctuation">;</span>
<span class="token keyword">use</span> swc_ecma_parser<span class="token punctuation">::</span><span class="token punctuation">{</span>lexer<span class="token punctuation">::</span>Lexer<span class="token punctuation">,</span> Parser<span class="token punctuation">,</span> StringInput<span class="token punctuation">,</span> Syntax<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span><span class="token keyword">dyn</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cm<span class="token punctuation">:</span> Lrc<span class="token operator">&lt;</span>SourceMap<span class="token operator">&gt;</span> <span class="token operator">=</span> Default<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> handler <span class="token operator">=</span> Handler<span class="token punctuation">::</span><span class="token function">with_tty_emitter</span><span class="token punctuation">(</span>ColorConfig<span class="token punctuation">::</span>Auto<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span>cm<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> fm <span class="token operator">=</span> cm
        <span class="token punctuation">.</span><span class="token function">load_file</span><span class="token punctuation">(</span>Path<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"./src/test.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"failed to load test.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lexer <span class="token operator">=</span> Lexer<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        Syntax<span class="token punctuation">::</span><span class="token function">Es</span><span class="token punctuation">(</span>Default<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Default<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        StringInput<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>fm<span class="token punctuation">)</span><span class="token punctuation">,</span>
        None<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> parser <span class="token operator">=</span> Parser<span class="token punctuation">::</span><span class="token function">new_from</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> e <span class="token keyword">in</span> parser<span class="token punctuation">.</span><span class="token function">take_errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">into_diagnostic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> _module <span class="token operator">=</span> parser
        <span class="token punctuation">.</span><span class="token function">parse_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span>e<span class="token operator">|</span> e<span class="token punctuation">.</span><span class="token function">into_diagnostic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"failed to parser module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> context <span class="token operator">=</span> Context<span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_module</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> builder <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">create_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> b <span class="token keyword">in</span> _module<span class="token punctuation">.</span>body <span class="token punctuation">{</span>
        <span class="token keyword">if</span> b<span class="token punctuation">.</span><span class="token function">is_stmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> stmt <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">stmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> stmt<span class="token punctuation">.</span><span class="token function">is_expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> expr_stmt <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> expr <span class="token operator">=</span> expr_stmt<span class="token punctuation">.</span>expr<span class="token punctuation">;</span>
                <span class="token keyword">if</span> expr<span class="token punctuation">.</span><span class="token function">is_bin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> bin_expr <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">bin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> left_expr <span class="token operator">=</span> bin_expr<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
                    <span class="token keyword">let</span> right_expr <span class="token operator">=</span> bin_expr<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
                    <span class="token keyword">let</span> binary_op <span class="token operator">=</span> bin_expr<span class="token punctuation">.</span>op<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> left_expr<span class="token punctuation">.</span><span class="token function">is_lit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> right_expr<span class="token punctuation">.</span><span class="token function">is_lit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> left_lit <span class="token operator">=</span> left_expr<span class="token punctuation">.</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> right_lit <span class="token operator">=</span> right_expr<span class="token punctuation">.</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> left_value <span class="token operator">=</span> <span class="token keyword">match</span> left_lit <span class="token punctuation">{</span>
                            <span class="token function">Num</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            _ <span class="token operator">=&gt;</span> <span class="token number">0f64</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> right_value <span class="token operator">=</span> <span class="token keyword">match</span> right_lit <span class="token punctuation">{</span>
                            <span class="token function">Num</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                            _ <span class="token operator">=&gt;</span> <span class="token number">0f64</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> i64_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">i64_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> void_type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">void_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> fn_type <span class="token operator">=</span> void_type<span class="token punctuation">.</span><span class="token function">fn_type</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> function <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">add_function</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> fn_type<span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> basic_block <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">append_basic_block</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> <span class="token string">"entry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        builder<span class="token punctuation">.</span><span class="token function">position_at_end</span><span class="token punctuation">(</span>basic_block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> x <span class="token operator">=</span> i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span>left_value <span class="token keyword">as</span> u64<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> y <span class="token operator">=</span> i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span>right_value <span class="token keyword">as</span> u64<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">match</span> binary_op <span class="token punctuation">{</span>
                            swc_ecma_ast<span class="token punctuation">::</span>BinaryOp<span class="token punctuation">::</span>Add <span class="token operator">=&gt;</span> builder<span class="token punctuation">.</span><span class="token function">build_int_add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            swc_ecma_ast<span class="token punctuation">::</span>BinaryOp<span class="token punctuation">::</span>Sub <span class="token operator">=&gt;</span> builder<span class="token punctuation">.</span><span class="token function">build_int_sub</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            swc_ecma_ast<span class="token punctuation">::</span>BinaryOp<span class="token punctuation">::</span>Div <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                builder<span class="token punctuation">.</span><span class="token function">build_int_signed_div</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                            swc_ecma_ast<span class="token punctuation">::</span>BinaryOp<span class="token punctuation">::</span>Mul <span class="token operator">=&gt;</span> builder<span class="token punctuation">.</span><span class="token function">build_int_mul</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            _ <span class="token operator">=&gt;</span> i64_type<span class="token punctuation">.</span><span class="token function">const_int</span><span class="token punctuation">(</span><span class="token number">0u64</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        builder<span class="token punctuation">.</span><span class="token function">build_return</span><span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> e <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">create_jit_execution_engine</span><span class="token punctuation">(</span>OptimizationLevel<span class="token punctuation">::</span>None<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
                        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
                            <span class="token keyword">let</span> r <span class="token operator">=</span> e
                                <span class="token punctuation">.</span>get_function<span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> u64<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token operator">?</span>
                                <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>実行してみます。</p>
<pre class="language-shell"><code class="language-shell">$ cargo run
<span class="token number">2</span>
</code></pre>
<p><code>20 / 10</code>つまり、<code>2</code>が出力されました！やった！</p>
<h1 id="終わりに"><a class="anchor" href="#終わりに"><svg class="octicon octicon-link" viewBox="0 0 16 16" aria-hidden="true" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>終わりに</h1>
<p>これにて、簡単なjavascriptコードをパースし、LLVMで実行できるところまでたどり着きました。
当初、LLVMの使い方って全然わからなかったのですが、段階的にできる部分が増えると、分かる領域が増えて、モチベーションが高まります。
LLVMの勉強をされている方、参考にしてみてください。</p>

  
    <div class="content-footer">
  <p>
    Caught a mistake or want to improve the blog?
    <a href="https://github.com/Silver-birder/Silver-birder.github.io/edit/main/./docs/blog/contents/intro_to_LLVM-JIT_compilation_of_javascript_with_LLVM_Rust_inkwell.md">Edit this blog post on GitHub!</a>
  </p>
</div>


  
</main>

  </main>

    </div>
  </div>


    
      <footer id="main-footer">
  
    

  
    <div id="footer-menu">
  <div class="content-area">
    
      <nav>
        <h3>Discover</h3>
        <ul>
          
            <li>
              <a href="https://silver-birder.github.io/blog/">Blog</a>
            </li>
          
            <li>
              <a href="https://github.com/Silver-birder/Silver-birder.github.io/issues">Help and Feedback</a>
            </li>
          
        </ul>
      </nav>
    
      <nav>
        <h3>My Sales</h3>
        <ul>
          
            <li>
              <a href="https://www.amazon.co.jp/芝本雅史/e/B08FJK5C43">Amazon</a>
            </li>
          
            <li>
              <a href="https://silverbirder.booth.pm">Booth</a>
            </li>
          
        </ul>
      </nav>
    
      <nav>
        <h3>Follow</h3>
        <ul>
          
            <li>
              <a href="https://github.com/Silver-birder/Silver-birder.github.io">GitHub</a>
            </li>
          
            <li>
              <a href="https://twitter.com/silver_birder">Twitter</a>
            </li>
          
            <li>
              <a href="https://www.google.com/maps/contrib/101722346324226588907/reviews/@34.6907839,135.4537926,13z/">Google Map</a>
            </li>
          
        </ul>
      </nav>
    
  </div>
</div>

  
</footer>

    

    
  


  

<script>
  window.__rocketServiceWorkerUrl = '/service-worker.js';
</script>






  
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-146805630-4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-146805630-4');
  </script>




  


<script type="module" src="../../../b089d234.js"></script>
<script type="module" src="../../../46ae44d0.js"></script>
<script type="module" src="../../../dd4fcd54.js" inject-service-worker=""></script>
<script type="module" src="../../../736906bb28.js"></script>

</body></html>