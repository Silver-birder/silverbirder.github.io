---
title: 「マイクロフロントエンド」を読みました
published: true
date: 2022-11-06
description: XXX
tags: ["Micro Frontends", "Review"]
---

DAZN の Luca Mezzalira さんが書かれた[マイクロフロントエンド](https://www.oreilly.co.jp/books/9784814400027/) を読みました。その書籍レビューを残しておこうかなと思います。

## 前提 マイクロフロントエンドって？

マイクロフロントエンドは、雑に言うと、マイクロサービスをフロントエンドへ拡張した設計手法です。
詳しくは、https://micro-frontends-japanese.org/ を御覧ください。

## 1 章 フロントエンドのいま

フロントエンドのこれまでのアーキテクチャについて紹介されています。

- 静的 Web サイト
- SPA
- Jamstack
- アイソモーフィック

各アーキテクチャのメリット・デメリットの話があり、多くはユーザー体験の話題が多かったです。

- ユーザー体験
  - ロード
  - インタラクション
- 組織
  - 肥大化コードベース
  - 分散チーム
- システム
  - サーバ スケーラビリティ

マイクロフロントエンドは、これらに並ぶ 1 つの設計手法であり、マイクロサービスアーキテクチャと似たメリット・デメリットがあります。
マイクロフロントエンドのメリット・デメリットの一例として、次が挙げられます。

- メリット
  - 認知負荷の低減
  - 専門性と独立性の向上
- デメリット
  - オーバーヘッドの発生
    - 自動化やガバナンス
    - 観測
    - 人とのコミュニケーション
  - パフォーマンス

<!-- これは個人の感想ですが、これまでのフロントエンドアーキテクチャは、ブラウザというプラットフォーム上という制約下におけるユーザー体験に重きを置いていて、
マイクロフロントエンドは、組織や開発者といった社内への重きが大きい印象です。副次的な効果として、スピーディーな価値提供、統一的な UX 提供というメリットもあると思っています。 -->

## 2 章 マイクロフロントエンドの原則

マイクロフロントエンドの原則の前に、なぜマイクロフロントエンドって必要なんだろうという小話をします。

新規プロダクト開発において、モノリスファーストでアプリケーション開発を行い、ビジネスへの成功を最優先します。
その後、機能開発と並行して、ビジネスのスケールに対応できるように、バックエンドのマイクロサービス化などの対応が進められます。
マイクロフロントエンドも、同じ理由で対応が求められます。マイクロフロントエンドの場合は、UI がキーワードと思いますが、**UI のスケーラビリティ** のために、マイクロフロントエンドはあるんだと思います。

では、マイクロフロントエンドの原則について、列挙だけしておきます。

- ビジネスドメインのモデル化
- 自動化の文化
- 実装の詳細を隠す
- ガバナンスの分散
- 独立デプロイ可能性
- 障害の分散
- 高い観測性

マイクロサービスにも当てはまる原則かなと思います。

## 3 章 マイクロフロントエンドアーキテクチャとその課題

マイクロフロントエンドアーキテクチャは、次の要素を持つべきだと書かれています。

- チームは、自律的に行動できること
- マイクロフロントエンドは、独立してデプロイ可能であること
- 単一のチームに、単一のビジネスドメインを所有すること

また、マイクロフロントエンドは、次のどちらかの定義になります。

- 垂直分割
  - 1 つの画面に、単一のマイクロフロントエンド
- 水平分割
  - 1 つの画面に、複数のマイクロフロントエンド

また、DDD の話がありました。これは、フロントエンドを分割する際に役立ちます。
Netflix を例に、コアドメイン、サブドメイン、コンテキストの境界について、説明がありました。

サブドメインを、1 つのマイクロフロントエンドと定義していきます。
垂直分割の場合、1 つの画面に 1 つのサブドメインを使用するため、シンプルな開発ができます。
また、垂直分割の場合、SPA の開発スタイルと似ている傾向があるため、はじめてマイクロフロントエンドをする場合は、垂直分割がお勧めのようです。

マイクロフロントエンドでは、組成パターンについても触れられています。
組成は、各マイクロフロントエンドを 1 つの画面に組み合わせることを指し、どの領域で組成するかという話になります。

- クライアント
  - ブラウザ上で組成
  - ブラウザ上のパフォーマンスの課題がある
- エッジ
  - Edge 上で組成
  - CDN の恩恵を受けられる
  - 逆に、CDN の制約がある
- サーバ
  - サーバ上で組成
  - 最も自由度が高い(コントロールしやすい)
  - スケーラビリティの考慮が必要

アプリケーションとしては、(イベント伝搬などの)コミュニケーション、認証、ローカライゼーションなども考えることになります。

## 4 章 マイクロフロントエンドアーキテクチャの発見

本書で一番長い章です。

### 垂直分割と水平分割

垂直分割と水平分割は、どちらを選ぶべきかという話がありました。
垂直分割は従来の SPA 開発と似ているため、まずはじめにやるなら垂直分割に、
次の理由があれば、水平分割をしましょう。

- 1 つのサブドメインを複数の画面で表示する
- 画面の特定部分をユーザがカスタマイズできる
- 検索エンジン最適化(SSR)
- 開発者が数百人以上存在し、サブドメインを分割しなければならない

これ以降も、度々『垂直分割から始めましょう』と書かれています。組成パターンは、クライアントです。
ちなみに、マイクロフロントエンドは、その性質上、マイグレーションとセットです。
既存のアプリケーションを画面単位で置き換えるか、サブドメイン単位で置き換えるかは、ケースバイケースです。

水平分割の場合、同じ画面内のマイクロフロントエンドの数を減らしましょう。もしかしたら過剰設計に陥っているかもしれません。

### AppShell

マイクロフロントエンドアーキテクチャには、AppShell というマイクロフロントエンドを司る機能が必要です。
AppShell には、次のようなオーケストレーション機能が必要です。

- ユーザーの初期状態の処理
- アプリ全体で使用される設定の取得
- ロードを行うため利用できるルートと関連するマイクロフロントエンドの取得
- ロギング、可観測性、マーケティングライブラリの設定
- マイクロフロントエンドがロードできない場合のエラー処理

### パフォーマンス

マイクロフロントエンドアーキテクチャにも、パフォーマンス問題が発生します。
水平分割のアプローチでは、複数のマイクロフロントエンドが 1 つの画面にロードされるため、単純に合計バイト数をブラウザにロードすることになります。この問題には、モジュールフェデレーションや、遅延ロード、予測ロードが有効です。

ちなみにマルチフレームワーク(React と Vue とか)は、パフォーマンスの課題などがあるため、本書では非推奨と書いています。
ただし、MVP の一環として一時的なマルチフレームワークは、アリだと個人的に思っています。

### デザインシステム

マイクロフロントエンドをすすめると、デザインのトンマナが気になります。
そのため、デザインシステムをベースにマイクロフロントエンド開発をしましょう。

- デザイントークン
- 基本コンポーネント
- UI コンポーネント

コンポーネントについては、WebComponents は良いソリューションです。Shadow DOM により、スタイルはコンポーネント内部に留まりますし、UI フレームワークに依存しません。

### マイクロフロントエンドとコンポーネント

マイクロフロントエンドとコンポーネントは、一緒じゃないか？と思う人もいるかもしれません。
本書では、次のように区別しています。

- マイクロフロントエンド
  - サブドメインのビジネス表現
  - ロジックをカプセル化し、イベント通信
- コンポーネント
  - 再利用性の目的で使用される技術的ソリューション
  - 拡張しやすく複数のプロパティを公開

### 文書の明文化

複数チームでコラボレーションする場合、人とのコミュニケーションコストは、必ず発生します。
定期的な MTG を開いたり、仕様についての確認など、あらゆるコミュニケーションがあります。
そういったときに、文書を明文化しておくと、コスト削減できます。
エンジニアリングの面でいうと、RFC という文書を残しておくことをお勧めします。

個人的には、Design Doc で設計書を書き、RFC で意見を集め、ADR で設計変更を記録する、の順番で書いていくのが良いと思っています。

### その他

マイクロフロントエンドは、開発者体験や自動化パイプラインを整えておく必要があります。
また、認知負荷が高まったり、マイクロフロントエンド間の依存関係が増えた場合は、サブドメインの境界を見直しましょう。

## 5 章 マイクロフロントエンドの技術実装

マイクロフロントエンドを、EC サイトを例に紹介。

- https://github.com/aws-samples/talk-dev-to-me-twitch/tree/main/micro-frontends-module-federation

## 6 章 マイクロフロントエンドの構築とデプロイ

マイクロフロントエンドは、単一で動くだけじゃなく、それを使う場所でも動かせるように、関係者が多いです。
CI/CD の自動化を適切にしないと、フラストレーションが溜まってしまいます。

- Mono-Repo
  - コードの再利用性がしやすく、まとまりのあるコードベース
  - 依存関係管理がシンプル
  - 大規模コードリファクタリングがしやすい
  - しかし
    - 自動化ツールの継続的な投資
    - コードベースが大きくなったときのスケーリング
    - 行儀のよい開発者
- Poly-Repo
  - プロジェクトごとにブランチ戦略を採用できる
  - 相互関係を契約(スキーマファースト)で設計する
  - きめ細かいアクセス制御
  - しかし
    - コードの重複
    - プロジェクトが発見しにくい
    - メンテナンスのプラクティス

## 7 章 事例 マイクロフロントエンドのための自動化パイプライン

サンプル会社の環境構築や自動化パイプライン(CI/CD)について、紹介

## 8 章 マイクロフロントエンド用のバックエンドパターン

サービスディクショナリパターン、API ゲートウェイ、GraphQL が、話題になりました。

## 9 章 事例 モノリスからマイクロフロントエンドへ

マイグレーション。

## 10 章 組織にマイクロフロントエンドを導入する

TBD

## 付録 開発者インタビュー マイクロフロントエンドとの向き合い方

マイクロフロントエンドを知らない人向けに、ワークショップを開いているみたい。
必須として、バージョン管理、スケールデプロイインフラ。

マイクロフロントエンドを始める第一歩は？

1. PoC をして、する・しないを判断する
2. 既存アプリを単一 MFE としてリリース
3. 画面に共有コンポーネントを MFE としてリリース
4. 次の新機能を MFE としてリリース
5. モノリスの小規模を MFE としてリリース

マイクロフロントエンド、例えば、大規模アプリケーションの会社であったり、数多く開発しているプロダクトの会社で、
UI エンジニアのコストが大変だなと。だいたい、どちらかな気がする。

マイクロフロントエンドの目的は、Scaling UI Development という言葉が好きになった。

## 参考

関連するマイクロフロントエンドの書籍です。

- [Micro Frontends in Action](https://www.oreilly.com/library/view/micro-frontends-in/9781617296871/)
- [マイクロフロントエンド(洋書版)](https://www.oreilly.com/library/view/building-micro-frontends/9781492082989/)
